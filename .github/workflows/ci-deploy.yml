name: CI and Deploy

on:
  push:
    branches:
      - master
      - develop

env:
  ARTIFACT_NAME: gs-rest-service.jar

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      jar-path: ${{ steps.upload-artifact.outputs.artifact-path || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Notify Slack: build started
        if: ${{ secrets.SLACK_CI_WEBHOOK }}
        run: |
          curl -s -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"CI: Build started for \`${{ github.ref }}\` (<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|commit>)\"}" \
            ${{ secrets.SLACK_CI_WEBHOOK }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build and test
        run: mvn -B -DskipTests=false clean package

      - name: Archive built jar
        uses: actions/upload-artifact@v4
        with:
          name: gs-rest-service-jar
          path: target/*.jar

      - name: Notify Slack: build finished
        if: ${{ secrets.SLACK_CI_WEBHOOK }}
        run: |
          STATUS="SUCCESS"
          if [ "${{ job.status }}" != "Success" ]; then STATUS="FAILED"; fi
          curl -s -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"CI: Build $STATUS for \`${{ github.ref }}\` - <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|commit>\"}" \
            ${{ secrets.SLACK_CI_WEBHOOK }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: gs-rest-service-jar
          path: ./deploy_artifact

      - name: Setup SSH key
        if: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts

      - name: Copy artifact and deploy via SSH
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH || '/home/${{ secrets.SERVER_USER }}/gs-rest' }}
        run: |
          scp ./deploy_artifact/*.jar "${SERVER_USER}@${SERVER_HOST}:~/app.jar"
          ssh "${SERVER_USER}@${SERVER_HOST}" <<'SSH_EOF'
            set -e
            # ensure docker is available on the server, else run jar directly
            if command -v docker >/dev/null 2>&1; then
              # create a simple Dockerfile on the host and build/run
              cat > Dockerfile.deploy <<'DOCK'
              FROM eclipse-temurin:17-jre-jammy
              COPY app.jar /app/app.jar
              EXPOSE 777
              ENTRYPOINT ["sh", "-c", "exec java -jar /app/app.jar --server.port=777"]
              DOCK
              docker build -t gs-rest-service:latest -f Dockerfile.deploy .
              # stop and remove existing container if exists
              if [ "$(docker ps -aq -f name=gs-rest-service)" != "" ]; then
                docker rm -f gs-rest-service || true
              fi
              docker run -d --name gs-rest-service -p 777:777 --restart unless-stopped gs-rest-service:latest
            else
              # run jar as background process (fallback)
              pkill -f 'app.jar' || true
              nohup java -jar ~/app.jar --server.port=777 > ~/app.log 2>&1 &
            fi
          SSH_EOF

      - name: Notify Slack: deployed
        if: ${{ secrets.SLACK_CI_WEBHOOK }}
        run: |
          curl -s -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"Deployment: artifact deployed to \`${{ secrets.SERVER_HOST }}\` on port 777 by ${{ github.actor }}\"}" \
            ${{ secrets.SLACK_CI_WEBHOOK }}
