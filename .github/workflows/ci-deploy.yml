name: CI and Deploy

on:
  push:
    branches:
      - main
      - master
      - develop

env:
  ARTIFACT_NAME: gs-rest-service.jar

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      jar-path: ${{ steps.archive.outputs.artifact-path || '' }}
    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # Slack: Build Started
      - name: Notify Slack: build started
        if: ${{ secrets.SLACK_CI_WEBHOOK }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_CI_WEBHOOK }}
        run: |
          REF=${GITHUB_REF}
          REPO=${GITHUB_REPOSITORY}
          SHA=${GITHUB_SHA}
          curl -s -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"CI: Build started for branch ${REF} (<https://github.com/${REPO}/commit/${SHA}|commit>)\"}" \
            $SLACK_WEBHOOK

      # Setup Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # Build and test Maven project
      - name: Build and test
        run: mvn -B -DskipTests=false clean package

      # Archive artifact
      - name: Archive built jar
        id: archive
        uses: actions/upload-artifact@v4
        with:
          name: gs-rest-service-jar
          path: target/*.jar

      # Slack: Build Finished
      - name: Notify Slack: build finished
        if: ${{ secrets.SLACK_CI_WEBHOOK }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_CI_WEBHOOK }}
        run: |
          STATUS="SUCCESS"
          if [ "${{ job.status }}" != "Success" ]; then STATUS="FAILED"; fi
          REF=${GITHUB_REF}
          REPO=${GITHUB_REPOSITORY}
          SHA=${GITHUB_SHA}
          curl -s -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"CI: Build ${STATUS} for branch ${REF} (<https://github.com/${REPO}/commit/${SHA}|commit>)\"}" \
            $SLACK_WEBHOOK

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      # Download artifact
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: gs-rest-service-jar
          path: ./deploy_artifact

      # Setup SSH key
      - name: Setup SSH key
        if: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        env:
          SSH_KEY: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts

      # Copy artifact and deploy via SSH
      - name: Copy artifact and deploy via SSH
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH || '/home/${{ secrets.SERVER_USER }}/gs-rest' }}
        run: |
          scp ./deploy_artifact/*.jar "${SERVER_USER}@${SERVER_HOST}:~/app.jar"
          ssh "${SERVER_USER}@${SERVER_HOST}" <<'SSH_EOF'
            set -e
            # Docker deploy if available
            if command -v docker >/dev/null 2>&1; then
              cat > Dockerfile.deploy <<'DOCK'
              FROM eclipse-temurin:17-jre-jammy
              COPY app.jar /app/app.jar
              EXPOSE 777
              ENTRYPOINT ["sh", "-c", "exec java -jar /app/app.jar --server.port=777"]
              DOCK
              docker build -t gs-rest-service:latest -f Dockerfile.deploy .
              if [ "$(docker ps -aq -f name=gs-rest-service)" != "" ]; then
                docker rm -f gs-rest-service || true
              fi
              docker run -d --name gs-rest-service -p 777:777 --restart unless-stopped gs-rest-service:latest
            else
              # Fallback: run jar directly
              pkill -f 'app.jar' || true
              nohup java -jar ~/app.jar --server.port=777 > ~/app.log 2>&1 &
            fi
          SSH_EOF

      # Slack: Deployment notification
      - name: Notify Slack: deployed
        if: ${{ secrets.SLACK_CI_WEBHOOK }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_CI_WEBHOOK }}
          SERVER: ${{ secrets.SERVER_HOST }}
        run: |
          curl -s -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"Deployment: artifact deployed to \`${SERVER}\` on port 777 by ${GITHUB_ACTOR}\"}" \
            $SLACK_WEBHOOK
